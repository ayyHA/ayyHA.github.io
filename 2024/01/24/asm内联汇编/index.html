

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.png">
  <link rel="icon" href="/img/favicon.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="学习下asm内联汇编的基本格式,以便于微内核的编写">
  <meta name="author" content="John Doe">
  <meta name="keywords" content="">
  <meta name="description" content="学习下asm内联汇编的基本格式,以便于微内核的编写">
<meta property="og:type" content="article">
<meta property="og:title" content="asm内联汇编">
<meta property="og:url" content="http://example.com/2024/01/24/asm%E5%86%85%E8%81%94%E6%B1%87%E7%BC%96/index.html">
<meta property="og:site_name" content="ayyHA&#39;s blog">
<meta property="og:description" content="学习下asm内联汇编的基本格式,以便于微内核的编写">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2024-01-24T09:07:56.000Z">
<meta property="article:modified_time" content="2024-04-24T02:22:57.089Z">
<meta property="article:author" content="John Doe">
<meta property="article:tag" content="内联汇编">
<meta property="article:tag" content="内嵌汇编">
<meta property="article:tag" content="assemble">
<meta name="twitter:card" content="summary_large_image">
  
  <title>asm内联汇编 - ayyHA&#39;s blog</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4/github-markdown.min.css" />
  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10/styles/github-gist.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.css" />
  


<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->

  
<link rel="stylesheet" href="/css/mouse.css">



  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.8.12","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"baidu":"9c7ed39aa5906acb06d9f9cb7df236ae","google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname"}},"search_path":"/local-search.xml"};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.4.0"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>ayyHA</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('/img/default.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="asm内联汇编">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2024-01-24 17:07" pubdate>
        2024年1月24日 下午
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      6.9k 字
    </span>
  

  
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      21 分钟
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">asm内联汇编</h1>
            
              <p class="note note-info">
                
                  本文最后更新于：2 个月前
                
              </p>
            
            <div class="markdown-body">
              <h2 id="写在开头"><a class="markdownIt-Anchor" href="#写在开头"></a> 写在开头</h2>
<p>本文所描述的内联汇编主要用于算子开发,因此涉及到的知识面相对可能较窄.如果有内容没涉及到,大概是作者还没使用到相关的知识~</p>
<p>文中对内联汇编的一些定义解释会引用<strong>GCC Extended-ASM</strong><sup id="fnref:1" class="footnote-ref"><a href="#fn:1" rel="footnote"><span class="hint--top hint--rounded" aria-label="GNU Extended-ASM
">[1]</span></a></sup>的原文,毕竟翻译过来容易变味,不利于使用者理解</p>
<h2 id="基本格式"><a class="markdownIt-Anchor" href="#基本格式"></a> 基本格式</h2>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">asm</span> <span class="hljs-keyword">asm</span>-<span class="hljs-built_in">qualifiers</span> ( AssemblerTemplate <br>                 : OutputOperands <br>                 [ : InputOperands<br>                 [ : Clobbers ] ])<br></code></pre></td></tr></table></figure>
<p>第一个asm是<strong>关键字</strong>,建议使用**<code>__asm__</code>**而非<code>asm</code>,原因如下:</p>
<blockquote>
<p>The <code>asm</code> keyword is a GNU extension. When writing code that can be compiled with -ansi and the various -std options, use <code>__asm__</code> instead of <code>asm</code> (see <a target="_blank" rel="noopener" href="https://gcc.gnu.org/onlinedocs/gcc/Alternate-Keywords.html">Alternate Keywords</a>).</p>
</blockquote>
<hr />
<p>**asm的修饰符(qualifiers)**有三个</p>
<ul>
<li>
<p><strong>volatile</strong>: 告知GCC这里不用优化(就是这里禁用优化)</p>
<blockquote>
<p>The typical use of extended <code>asm</code> statements is to manipulate input values to produce output values. However, your <code>asm</code> statements may also produce side effects. If so, you may need to use the <code>volatile</code> qualifier to disable certain optimizations. See <a target="_blank" rel="noopener" href="https://gcc.gnu.org/onlinedocs/gcc/Extended-Asm.html#Volatile">Volatile</a>.</p>
</blockquote>
</li>
<li>
<p><strong>inline</strong>:</p>
</li>
<li>
<p><strong>goto</strong>:</p>
</li>
</ul>
<hr />
<p><strong>AssemblerTemplate</strong>则用于放置汇编语句,用<code>&quot;&quot;</code>包裹住每一句汇编语句</p>
<hr />
<p><strong>OutputOperands</strong>,这个列表以<code>:</code>开头,用于放置<strong>输出操作数</strong>,列表中的<strong>各个操作数以<code>,</code>分隔</strong>.输出操作数<strong>一般至少用于只写(覆盖)</strong>.操作数的格式如下:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">[ [asmSymbolicName] ] constraint (cvariablename)<br></code></pre></td></tr></table></figure>
<p>其中<code>[asmSymbolicName]</code>是C中变量<code>cvariablename</code>在汇编中的符号名,一般同名更有利于我们编写汇编,在AssemblerTemplate中可以通过**<code>%[asmSymbolicName]</code>**来进行调用</p>
<p>不想用符号名的话则按照输出操作数到输入操作数的变量名的顺序,依次为<code>%0</code>,<code>%1</code>,…</p>
<p><code>(cvariablename)</code>则用于填写我们C中的变量名</p>
<p>constraint约束,是一个<strong>字符串常量</strong>,<strong>指定操作数的约束条件</strong>.它需要以<code>=</code>(覆盖现有值的变量,即只写)或者<code>+</code>(既读又写时)作为字串开头</p>
<blockquote>
<p>Output constraints must begin with either ‘=’ (a variable overwriting an existing value) or ‘+’ (when reading and writing). When using ‘=’, do not assume the location contains the existing value on entry to the <code>asm</code>, except when the operand is tied to an input; see <a target="_blank" rel="noopener" href="https://gcc.gnu.org/onlinedocs/gcc/Extended-Asm.html#InputOperands">Input Operands</a>.</p>
</blockquote>
<p>在上面的前缀后,须有一个或多个额外的约束,来<strong>描述值所在的位置</strong>.比如寄存器的<code>r</code>和内存的<code>m</code>.<strong>当列出多个可能的位置,则编译器会根据上下文选择最有效的位置</strong>.</p>
<blockquote>
<p>After the prefix, there must be one or more additional constraints (see <a target="_blank" rel="noopener" href="https://gcc.gnu.org/onlinedocs/gcc/Constraints.html">Constraints for <code>asm</code> Operands</a>) that describe where the value resides. Common constraints include ‘r’ for register and ‘m’ for memory. When you list more than one possible location (for example, <code>&quot;=rm&quot;</code>), the compiler chooses the most efficient one based on the current context. If you list as many alternates as the <code>asm</code> statement allows, you permit the optimizers to produce the best possible code. If you must use a specific register, but your Machine Constraints do not provide sufficient control to select the specific register you want, local register variables may provide a solution (see <a target="_blank" rel="noopener" href="https://gcc.gnu.org/onlinedocs/gcc/Local-Register-Variables.html">Specifying Registers for Local Variables</a>).</p>
</blockquote>
<hr />
<p><strong>InputOperands</strong>用于放置<strong>输入操作数</strong>,列表中的各操作数以<code>,</code>分隔,<strong>只用做输入用,即只读</strong>.它的格式如下:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">[ [asmSymbolicName] ] constraint (cexpression)<br></code></pre></td></tr></table></figure>
<p>这里基本上跟OutputOperands一样,但是<strong>作为约束的字串常量没有<code>=</code>或者<code>+</code>这些prefix,只是用来指示值所在的位置</strong>,比如<code>r</code>或者<code>m</code>.也可以给出多个可能的位置,让编译器根据上下文选择最有效的位置</p>
<hr />
<p><strong>Clobbers</strong>这个列表中的列表项,要么是<strong>寄存器名字</strong>,要么是<strong>特殊的clobber</strong>.每个列表项都是用<code>&quot;&quot;</code>括起来,用<code>,</code>分隔的字串常量</p>
<div class="note note-info">
            <p>虽说编译器知道我们会修改输出操作数,但是这其中的内联代码也会用到额外的寄存器,用的时候一些寄存器的值被覆盖掉了,这些被用的寄存器我们要告知编译器</p><blockquote><p>While the compiler is aware of changes to entries listed in the output operands, the inline <code>asm</code> code may modify more than just the outputs. For example, calculations may require additional registers, or the processor may overwrite a register as a side effect of a particular assembler instruction. In order to inform the compiler of these changes, list them in the clobber list. Clobber list items are either register names or the special clobbers (listed below). Each clobber list item is a string constant enclosed in double quotes and separated by commas.</p></blockquote>
          </div>
<p>而且我们的输入输出操作数可能约束中指定了要用寄存器来存放值,编译器在选择它们要用的寄存器时,不会用clobber列表中提及到的寄存器.因此,clobber中提及的寄存器可以用于汇编代码中任何用途.</p>
<blockquote>
<p>When the compiler selects which registers to use to represent input and output operands, it does not use any of the clobbered registers. As a result, clobbered registers are available for any use in the assembler code.</p>
</blockquote>
<p><strong>clobber列表中不给用stack pointer寄存器!!</strong></p>
<p>特殊的clobber:</p>
<ul>
<li>
<p><code>cc</code>:表示汇编代码修改了标志寄存器.某些机器,gcc会将条件代码表示为一个特定的硬件寄存器,cc用来命名该寄存器</p>
<blockquote>
<p>The <code>&quot;cc&quot;</code> clobber indicates that the assembler code modifies the flags register. On some machines, GCC represents the condition codes as a specific hardware register; <code>&quot;cc&quot;</code> serves to name this register. On other machines, condition code handling is different, and specifying <code>&quot;cc&quot;</code> has no effect. But it is valid no matter what the target.</p>
</blockquote>
</li>
<li>
<p><code>memory</code>: memory clobber告诉编译器,<strong>汇编代码对输入和输出操作数中列出的项以外的项执行内存读取或写入（例如，访问其中一个输入参数指向的内存）</strong>。<strong>为了确保内存包含正确的值，GCC可能需要在执行asm(内联汇编)之前将特定的寄存器值刷新到内存中</strong>。此外，编译器不假设在asm之前从内存读取的任何值在该asm之后保持不变；它会<strong>根据需要重新加载它们</strong>(根据需要做现场保护)。使用memory clobber有效地为编译器形成了一个读/写内存屏障。</p>
<blockquote>
<p>The <code>&quot;memory&quot;</code> clobber tells the compiler that the assembly code performs memory reads or writes to items other than those listed in the input and output operands (for example, accessing the memory pointed to by one of the input parameters). To ensure memory contains correct values, GCC may need to flush specific register values to memory before executing the <code>asm</code>. Further, the compiler does not assume that any values read from memory before an <code>asm</code> remain unchanged after that <code>asm</code>; it reloads them as needed. Using the <code>&quot;memory&quot;</code> clobber effectively forms a read/write memory barrier for the compiler.</p>
</blockquote>
</li>
</ul>
<h2 id="两个例子"><a class="markdownIt-Anchor" href="#两个例子"></a> 两个例子</h2>
<h3 id="risc-v的例子通过内联汇编实现系统调用"><a class="markdownIt-Anchor" href="#risc-v的例子通过内联汇编实现系统调用"></a> RISC-V的例子(通过内联汇编实现系统调用):</h3>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">read</span><span class="hljs-params">(<span class="hljs-keyword">int</span> __fd, <span class="hljs-keyword">const</span> <span class="hljs-keyword">void</span> *__buf, <span class="hljs-keyword">int</span> __n)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">int</span> bytes;<br>    __asm__ __volatile__(<br>        <span class="hljs-string">&quot;mv a0, %1           # file descriptor\n&quot;</span><br>        <span class="hljs-string">&quot;mv a1, %2           # buffer \n&quot;</span><br>        <span class="hljs-string">&quot;mv a2, %3           # size \n&quot;</span><br>        <span class="hljs-string">&quot;li a7, 63           # syscall read (63) \n&quot;</span><br>        <span class="hljs-string">&quot;ecall \n&quot;</span><br>        <span class="hljs-string">&quot;mv %0, a0&quot;</span><br>        : <span class="hljs-string">&quot;=r&quot;</span>(bytes)                     <span class="hljs-comment">// Output list</span><br>        : <span class="hljs-string">&quot;r&quot;</span>(__fd), <span class="hljs-string">&quot;r&quot;</span>(__buf), <span class="hljs-string">&quot;r&quot;</span>(__n) <span class="hljs-comment">// Input list</span><br>        : <span class="hljs-string">&quot;a0&quot;</span>, <span class="hljs-string">&quot;a1&quot;</span>, <span class="hljs-string">&quot;a2&quot;</span>, <span class="hljs-string">&quot;a7&quot;</span>);<br>    <span class="hljs-keyword">return</span> bytes;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">write</span><span class="hljs-params">(<span class="hljs-keyword">int</span> __fd, <span class="hljs-keyword">const</span> <span class="hljs-keyword">void</span> *__buf, <span class="hljs-keyword">int</span> __n)</span></span><br><span class="hljs-function"></span>&#123;<br>    __asm__ __volatile__(<br>        <span class="hljs-string">&quot;mv a0, %0           # file descriptor\n&quot;</span><br>        <span class="hljs-string">&quot;mv a1, %1           # buffer \n&quot;</span><br>        <span class="hljs-string">&quot;mv a2, %2           # size \n&quot;</span><br>        <span class="hljs-string">&quot;li a7, 64           # syscall write (64) \n&quot;</span><br>        <span class="hljs-string">&quot;ecall&quot;</span><br>        :                                 <span class="hljs-comment">// Output list</span><br>        : <span class="hljs-string">&quot;r&quot;</span>(__fd), <span class="hljs-string">&quot;r&quot;</span>(__buf), <span class="hljs-string">&quot;r&quot;</span>(__n) <span class="hljs-comment">// Input list</span><br>        : <span class="hljs-string">&quot;a0&quot;</span>, <span class="hljs-string">&quot;a1&quot;</span>, <span class="hljs-string">&quot;a2&quot;</span>, <span class="hljs-string">&quot;a7&quot;</span>);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">char</span> str[<span class="hljs-number">11</span>];<br>    <span class="hljs-keyword">int</span> n = <span class="hljs-built_in">read</span>(<span class="hljs-number">0</span>, str, <span class="hljs-number">11</span>);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;We already read %d chars&quot;</span>, n);<br>    <span class="hljs-built_in">write</span>(<span class="hljs-number">1</span>, str, n);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-keyword">void</span> _start()<br>&#123;<br>    <span class="hljs-built_in">main</span>();<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="aarch64的例子加权和dstj-weighted1-array1j-weigthed2-array2j"><a class="markdownIt-Anchor" href="#aarch64的例子加权和dstj-weighted1-array1j-weigthed2-array2j"></a> aarch64的例子(加权和<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi><mi>s</mi><mi>t</mi><mo stretchy="false">[</mo><mi>j</mi><mo stretchy="false">]</mo><mo>=</mo><mi>w</mi><mi>e</mi><mi>i</mi><mi>g</mi><mi>h</mi><mi>t</mi><mi>e</mi><mi>d</mi><mn>1</mn><mo>∗</mo><mi>a</mi><mi>r</mi><mi>r</mi><mi>a</mi><mi>y</mi><mn>1</mn><mo stretchy="false">[</mo><mi>j</mi><mo stretchy="false">]</mo><mo>+</mo><mi>w</mi><mi>e</mi><mi>i</mi><mi>g</mi><mi>t</mi><mi>h</mi><mi>e</mi><mi>d</mi><mn>2</mn><mo>∗</mo><mi>a</mi><mi>r</mi><mi>r</mi><mi>a</mi><mi>y</mi><mn>2</mn><mo stretchy="false">[</mo><mi>j</mi><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">dst[j] = weighted1 * array1[j] + weigthed2 * array2[j]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">d</span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mopen">[</span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mclose">]</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="mord mathnormal">e</span><span class="mord mathnormal">i</span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mord mathnormal">h</span><span class="mord mathnormal">t</span><span class="mord mathnormal">e</span><span class="mord mathnormal">d</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mord">1</span><span class="mopen">[</span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mclose">]</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="mord mathnormal">e</span><span class="mord mathnormal">i</span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mord mathnormal">t</span><span class="mord mathnormal">h</span><span class="mord mathnormal">e</span><span class="mord mathnormal">d</span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mord">2</span><span class="mopen">[</span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mclose">]</span></span></span></span>):</h3>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">arrayWeightSumInAsm</span><span class="hljs-params">(<span class="hljs-keyword">float</span>* array1,<span class="hljs-keyword">float</span> weighted1,</span></span><br><span class="hljs-params"><span class="hljs-function">                         <span class="hljs-keyword">float</span>* array2,<span class="hljs-keyword">float</span> weighted2,</span></span><br><span class="hljs-params"><span class="hljs-function">                         <span class="hljs-keyword">int</span> len,<span class="hljs-keyword">float</span>* dst)</span></span>&#123;<br>    <span class="hljs-keyword">int</span> neon_len = len &gt;&gt; <span class="hljs-number">2</span>;<br>    <span class="hljs-keyword">int</span> remain_len = len - (neon_len &lt;&lt; <span class="hljs-number">2</span>);<br> 	<span class="hljs-comment">// armv8</span><br>    <span class="hljs-function">__asm__ <span class="hljs-title">volatile</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">            <span class="hljs-comment">//  Instruction</span></span></span><br><span class="hljs-params"><span class="hljs-function">        <span class="hljs-comment">// 取64位寄存器的低32位,并dup到向量寄存器上</span></span></span><br><span class="hljs-params"><span class="hljs-function">        <span class="hljs-string">&quot;mov x0, %[weighted1] \n&quot;</span></span></span><br><span class="hljs-params"><span class="hljs-function">        <span class="hljs-string">&quot;dup v0.4s, w0 \n&quot;</span></span></span><br><span class="hljs-params"><span class="hljs-function">        <span class="hljs-string">&quot;mov x1, %[weighted2] \n&quot;</span></span></span><br><span class="hljs-params"><span class="hljs-function">        <span class="hljs-string">&quot;dup v1.4s, w1 \n&quot;</span></span></span><br><span class="hljs-params"><span class="hljs-function">        <span class="hljs-string">&quot;0:            \n&quot;</span></span></span><br><span class="hljs-params"><span class="hljs-function">        <span class="hljs-comment">// 预取数据,加载数据</span></span></span><br><span class="hljs-params"><span class="hljs-function">        <span class="hljs-string">&quot;prfm pldl1keep, [%[array1], #128] \n&quot;</span></span></span><br><span class="hljs-params"><span class="hljs-function">        <span class="hljs-string">&quot;ld1 &#123;v2.4s&#125;, [%[array1]], #16 \n&quot;</span></span></span><br><span class="hljs-params"><span class="hljs-function">        <span class="hljs-string">&quot;prfm pldl1keep, [%[array2], #128] \n&quot;</span></span></span><br><span class="hljs-params"><span class="hljs-function">        <span class="hljs-string">&quot;ld1 &#123;v3.4s&#125;, [%[array2]], #16 \n&quot;</span></span></span><br><span class="hljs-params"><span class="hljs-function">        <span class="hljs-comment">// 做乘法</span></span></span><br><span class="hljs-params"><span class="hljs-function">        <span class="hljs-string">&quot;fmul v4.4s, v0.4s, v2.4s \n&quot;</span></span></span><br><span class="hljs-params"><span class="hljs-function">        <span class="hljs-string">&quot;fmul v5.4s, v1.4s, v3.4s \n&quot;</span></span></span><br><span class="hljs-params"><span class="hljs-function">        <span class="hljs-comment">// 做加法</span></span></span><br><span class="hljs-params"><span class="hljs-function">        <span class="hljs-string">&quot;fadd v4.4s, v4.4s, v5.4s \n&quot;</span></span></span><br><span class="hljs-params"><span class="hljs-function">        <span class="hljs-comment">// 存数据</span></span></span><br><span class="hljs-params"><span class="hljs-function">        <span class="hljs-string">&quot;st1 &#123;v4.4s&#125;, [%[dst]], #16 \n&quot;</span></span></span><br><span class="hljs-params"><span class="hljs-function">        <span class="hljs-comment">// 自减neon_len,并影响状态位</span></span></span><br><span class="hljs-params"><span class="hljs-function">        <span class="hljs-string">&quot;subs %[neon_len], %[neon_len], #1 \n&quot;</span></span></span><br><span class="hljs-params"><span class="hljs-function">        <span class="hljs-comment">// 满足条件则跳转</span></span></span><br><span class="hljs-params"><span class="hljs-function">        <span class="hljs-string">&quot;bgt 0b \n&quot;</span></span></span><br><span class="hljs-params"><span class="hljs-function">        :[array1]    <span class="hljs-string">&quot;+r&quot;</span>(array1),</span></span><br><span class="hljs-params"><span class="hljs-function">         [array2]    <span class="hljs-string">&quot;+r&quot;</span>(array2),</span></span><br><span class="hljs-params"><span class="hljs-function">         [dst]       <span class="hljs-string">&quot;+r&quot;</span>(dst),</span></span><br><span class="hljs-params"><span class="hljs-function">         [neon_len]  <span class="hljs-string">&quot;+r&quot;</span>(neon_len)</span></span><br><span class="hljs-params"><span class="hljs-function">        :[weighted1] <span class="hljs-string">&quot;r&quot;</span>(weighted1),</span></span><br><span class="hljs-params"><span class="hljs-function">         [weighted2] <span class="hljs-string">&quot;r&quot;</span>(weighted2)</span></span><br><span class="hljs-params"><span class="hljs-function">        :<span class="hljs-string">&quot;cc&quot;</span>,<span class="hljs-string">&quot;memory&quot;</span>,<span class="hljs-string">&quot;x0&quot;</span>,<span class="hljs-string">&quot;x1&quot;</span>,<span class="hljs-string">&quot;v0&quot;</span>,<span class="hljs-string">&quot;v1&quot;</span>,<span class="hljs-string">&quot;v2&quot;</span>,<span class="hljs-string">&quot;v3&quot;</span>,<span class="hljs-string">&quot;v4&quot;</span>,<span class="hljs-string">&quot;v5&quot;</span></span></span><br><span class="hljs-params"><span class="hljs-function">    )</span></span>;<br>    <span class="hljs-comment">// 处理尾部数据</span><br>    <span class="hljs-keyword">while</span>(remain_len&gt;<span class="hljs-number">0</span>)&#123;<br>        *dst = *array1 * weighted1 + *array2 * weighted2;<br>        dst++;<br>        array1++;<br>        array2++;<br>        remain_len--;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h2 id="参考文件"><a class="markdownIt-Anchor" href="#参考文件"></a> 参考文件</h2>
<section class="footnotes"><div class="footnote-list"><ol><li><span id="fn:1" class="footnote-text"><span><a target="_blank" rel="noopener" href="https://gcc.gnu.org/onlinedocs/gcc/Extended-Asm.html#Extended-Asm">GNU Extended-ASM</a>
<a href="#fnref:1" rev="footnote" class="footnote-backref"> ↩</a></span></span></li><li><span id="fn:2" class="footnote-text"><span><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_42031299/article/details/132917965">c内嵌汇编总结</a>
<a href="#fnref:2" rev="footnote" class="footnote-backref"> ↩</a></span></span></li><li><span id="fn:3" class="footnote-text"><span><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_42258222/article/details/116501867">【ATT 与 Intel】汇编与C语言相互调用及内联汇编</a>
<a href="#fnref:3" rev="footnote" class="footnote-backref"> ↩</a></span></span></li><li><span id="fn:4" class="footnote-text"><span><a target="_blank" rel="noopener" href="https://blog.csdn.net/I_O_fly/article/details/127089091">RISCV汇编指令</a>
<a href="#fnref:4" rev="footnote" class="footnote-backref"> ↩</a></span></span></li></ol></div></section>
            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/%E5%86%85%E8%81%94%E6%B1%87%E7%BC%96/">内联汇编</a>
                    
                      <a class="hover-with-bg" href="/tags/%E5%86%85%E5%B5%8C%E6%B1%87%E7%BC%96/">内嵌汇编</a>
                    
                      <a class="hover-with-bg" href="/tags/assemble/">assemble</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">
                  
                    本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！
                  
                </p>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2024/01/24/%E5%90%91%E9%87%8Fintrinsic%E7%BC%96%E7%A8%8B/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">向量intrinsic编程</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2024/01/20/TensorRT%E5%AD%A6%E4%B9%A0/">
                        <span class="hidden-mobile">TensorRT学习</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
              <!-- Comments -->
              <article class="comments" id="comments" lazyload>
                
                  
                
                
  <div id="gitalk-container"></div>
  <script type="text/javascript">
    Fluid.utils.loadComments('#gitalk-container', function() {
      Fluid.utils.createCssLink('/css/gitalk.css')
      Fluid.utils.createScript('https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js', function() {
        var options = Object.assign(
          {"clientID":"1db059241d978c80eecd","clientSecret":"fa4f54290b2645c1dd4af84d9241dcb8c3e8e637","repo":"ayyBlog","owner":"ayyha","admin":["ayyha"],"language":"zh-CN","labels":["Gitalk"],"perPage":10,"pagerDirection":"last","distractionFreeMode":false,"createIssueManually":true,"proxy":"https://cors-anywhere.azm.workers.dev/https://github.com/login/oauth/access_token"},
          {
            id: '7533d35a7a74fc6d76f681ddcba6fb1f'
          }
        )
        var gitalk = new Gitalk(options);
        gitalk.render('gitalk-container');
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


              </article>
            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
  </div>
  
  <div class="statistics">
    
    

    
      
        <!-- 不蒜子统计PV -->
        <span id="busuanzi_container_site_pv" style="display: none">
            总访问量 
            <span id="busuanzi_value_site_pv"></span>
             次
          </span>
      
      
        <!-- 不蒜子统计UV -->
        <span id="busuanzi_container_site_uv" style="display: none">
            总访客数 
            <span id="busuanzi_value_site_uv"></span>
             人
          </span>
      
    
  </div>


  

  
</footer>


  <!-- SCRIPTS -->
  
  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->


  <script  src="/js/local-search.js" ></script>



  
    <script  src="/js/img-lazyload.js" ></script>
  



  



  
    <script  src="https://cdn.jsdelivr.net/npm/tocbot@4/dist/tocbot.min.js" ></script>
  
  
    <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.js" ></script>
  
  
    <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4/anchor.min.js" ></script>
  
  
    <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js" ></script>
  



  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>




  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
      typing(title)
      
    })(window, document);
  </script>





  

  
    <!-- KaTeX -->
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0/dist/katex.min.css" />
  








  
    <!-- Baidu Analytics -->
    <script defer>
      var _hmt = _hmt || [];
      (function () {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?9c7ed39aa5906acb06d9f9cb7df236ae";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
      })();
    </script>
  

  

  

  

  

  





<!-- 主题的启动项 保持在最底部 -->
<script  src="/js/boot.js" ></script>

  <script type="text/javascript" src="/js/funnyTitle.js"></script>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });
</script>
<script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"log":false,"model":{"scale":1,"hHeadPos":0.5,"vHeadPos":0.618,"jsonPath":"/live2dw/assets/assets/hijiki.model.json"},"display":{"position":"left","width":150,"height":300,"hOffset":30,"vOffset":-50,"superSample":2},"mobile":{"show":false},"react":{"opacityDefault":0.7,"opacityOnHover":0.2}});</script></body>
</html>
